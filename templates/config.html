{% extends "base.html" %}

{% block title %}ç³»ç»Ÿé…ç½® - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="section">
    <h2>âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
    
    <!-- å¾®ä¿¡APIé…ç½® -->
    <div style="margin-bottom: 30px; padding: 20px; background: #f7fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
        <h3 style="margin-bottom: 15px; color: #1a202c;">ğŸ“± å¾®ä¿¡APIé…ç½®</h3>
        <div class="form-group">
            <label>ğŸ“ é…ç½®åç§°ï¼ˆç”¨äºåŒºåˆ†ä¸åŒé…ç½®ï¼‰ï¼š</label>
            <input type="text" id="configName" placeholder="ä¾‹å¦‚ï¼šç”Ÿäº§ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒã€è´¦å·A...">
            <small style="display: block; margin-top: 5px; color: #718096;">è¾“å…¥ä¸€ä¸ªåç§°æ¥æ ‡è¯†è¿™ä¸ªé…ç½®ï¼Œä¾¿äºåŒºåˆ†å¤šä¸ªå¾®ä¿¡è´¦å·æˆ–ç¯å¢ƒ</small>
        </div>
        <div class="form-group">
            <label>ğŸ“‹ é€‰æ‹©å·²æœ‰é…ç½®ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <select id="configSelect" onchange="loadConfigBySelect()">
                <option value="">-- åˆ›å»ºæ–°é…ç½® --</option>
            </select>
        </div>
        <div class="form-group">
            <label>ğŸ”‘ å¾®ä¿¡AppIDï¼š</label>
            <input type="text" id="wechatAppId" placeholder="è¯·è¾“å…¥å¾®ä¿¡AppID">
        </div>
        <div class="form-group">
            <label>ğŸ” å¾®ä¿¡AppSecretï¼š</label>
            <input type="password" id="wechatAppSecret" placeholder="è¯·è¾“å…¥å¾®ä¿¡AppSecret">
            <button type="button" onclick="togglePassword('wechatAppSecret')" style="margin-top: 8px; padding: 6px 12px; font-size: 12px; background: #718096;">æ˜¾ç¤º/éšè—</button>
        </div>
        <button onclick="saveWechatConfig()">ğŸ’¾ ä¿å­˜å¾®ä¿¡é…ç½®</button>
        <div id="wechatConfigResult" style="margin-top: 15px;"></div>
    </div>
    
    <!-- æŸ¥çœ‹å½“å‰é…ç½® -->
    <div style="margin-top: 30px;">
        <h3 style="margin-bottom: 15px; color: #1a202c;">ğŸ“‹ å½“å‰é…ç½®</h3>
        <button onclick="loadConfig()" style="margin-bottom: 15px;">ğŸ”„ åˆ·æ–°é…ç½®</button>
        <div id="configList"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®
    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
        loadConfigNames();
    });
    
    // åˆ‡æ¢å¯†ç æ˜¾ç¤º/éšè—
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        if (input.type === 'password') {
            input.type = 'text';
        } else {
            input.type = 'password';
        }
    }
    
    // åŠ è½½é…ç½®åç§°åˆ—è¡¨ï¼ˆç”¨äºä¸‹æ‹‰é€‰æ‹©ï¼‰
    async function loadConfigNames() {
        const select = document.getElementById('configSelect');
        try {
            const result = await apiCall('/api/config');
            
            // è·å–æ‰€æœ‰å”¯ä¸€çš„é…ç½®åç§°
            const names = [...new Set(result.data
                .filter(c => c.name && (c.key === 'WECHAT_APP_ID' || c.key === 'WECHAT_APP_SECRET'))
                .map(c => c.name))];
            
            // æ¸…ç©ºé€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é€‰é¡¹ï¼‰
            select.innerHTML = '<option value="">-- åˆ›å»ºæ–°é…ç½® --</option>';
            
            // æ·»åŠ é…ç½®åç§°é€‰é¡¹
            names.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
        } catch (error) {
            console.error('åŠ è½½é…ç½®åç§°å¤±è´¥:', error);
        }
    }
    
    // æ ¹æ®é€‰æ‹©çš„é…ç½®åç§°åŠ è½½é…ç½®
    async function loadConfigBySelect() {
        const selectedName = document.getElementById('configSelect').value;
        if (!selectedName) {
            // æ¸…ç©ºè¡¨å•
            document.getElementById('configName').value = '';
            document.getElementById('wechatAppId').value = '';
            document.getElementById('wechatAppSecret').value = '';
            return;
        }
        
        try {
            const result = await apiCall('/api/config');
            const configs = result.data.filter(c => c.name === selectedName);
            
            const appId = configs.find(c => c.key === 'WECHAT_APP_ID');
            const appSecret = configs.find(c => c.key === 'WECHAT_APP_SECRET');
            
            // å¡«å……è¡¨å•
            document.getElementById('configName').value = selectedName;
            if (appId) {
                document.getElementById('wechatAppId').value = appId.value || '';
            }
            if (appSecret) {
                document.getElementById('wechatAppSecret').value = appSecret.value || '';
            }
        } catch (error) {
            showError(document.getElementById('wechatConfigResult'), `åŠ è½½é…ç½®å¤±è´¥: ${error.message}`);
        }
    }
    
    // ä¿å­˜å¾®ä¿¡é…ç½®
    async function saveWechatConfig() {
        const configName = document.getElementById('configName').value.trim();
        const appId = document.getElementById('wechatAppId').value.trim();
        const appSecret = document.getElementById('wechatAppSecret').value.trim();
        const resultDiv = document.getElementById('wechatConfigResult');
        const btn = event.target;
        
        if (!configName) {
            showError(resultDiv, 'è¯·è¾“å…¥é…ç½®åç§°');
            return;
        }
        
        if (!appId) {
            showError(resultDiv, 'è¯·è¾“å…¥å¾®ä¿¡AppID');
            return;
        }
        
        if (!appSecret) {
            showError(resultDiv, 'è¯·è¾“å…¥å¾®ä¿¡AppSecret');
            return;
        }
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btn.disabled = true;
        showLoading(resultDiv, 'æ­£åœ¨ä¿å­˜...');
        
        try {
            // ä¿å­˜AppID
            await apiCall('/api/config', {
                method: 'POST',
                body: {
                    name: configName,
                    key: 'WECHAT_APP_ID',
                    value: appId,
                    description: 'å¾®ä¿¡AppID'
                }
            });
            
            // ä¿å­˜AppSecret
            await apiCall('/api/config', {
                method: 'POST',
                body: {
                    name: configName,
                    key: 'WECHAT_APP_SECRET',
                    value: appSecret,
                    description: 'å¾®ä¿¡AppSecret'
                }
            });
            
            resultDiv.innerHTML = `<div class="success">âœ… å¾®ä¿¡é…ç½® "${escapeHtml(configName)}" ä¿å­˜æˆåŠŸï¼</div>`;
            // åˆ·æ–°é…ç½®åˆ—è¡¨å’Œåç§°åˆ—è¡¨
            loadConfig();
            loadConfigNames();
        } catch (error) {
            showError(resultDiv, `ä¿å­˜å¤±è´¥: ${error.message}`);
        } finally {
            btn.disabled = false;
        }
    }
    
    // åŠ è½½é…ç½®
    async function loadConfig() {
        const configListDiv = document.getElementById('configList');
        showLoading(configListDiv, 'åŠ è½½ä¸­...');
        
        try {
            const result = await apiCall('/api/config');
            
            if (result.data.length === 0) {
                configListDiv.innerHTML = '<div class="info">æš‚æ— é…ç½®</div>';
            } else {
                // æŒ‰åç§°åˆ†ç»„æ˜¾ç¤ºé…ç½®
                const configsByName = {};
                result.data.forEach(config => {
                    const name = config.name || '(æœªå‘½å)';
                    if (!configsByName[name]) {
                        configsByName[name] = [];
                    }
                    configsByName[name].push(config);
                });
                
                // ç”Ÿæˆé…ç½®åˆ—è¡¨HTML
                const configHtml = Object.keys(configsByName).map(name => {
                    const configs = configsByName[name];
                    const configItems = configs.map(config => {
                        let displayValue = config.value || '(æœªè®¾ç½®)';
                        // å¯¹æ•æ„Ÿä¿¡æ¯è¿›è¡Œæ©ç å¤„ç†
                        if (config.key === 'WECHAT_APP_SECRET' && displayValue !== '(æœªè®¾ç½®)') {
                            displayValue = displayValue.length > 8 
                                ? displayValue.substring(0, 4) + '****' + displayValue.substring(displayValue.length - 4)
                                : '****';
                        }
                        
                        return `
                            <div style="margin-bottom: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">
                                <strong style="color: #667eea;">${escapeHtml(config.key)}</strong>
                                ${config.description ? `<small style="display: block; margin-top: 5px; color: #718096;">${escapeHtml(config.description)}</small>` : ''}
                                <div style="margin-top: 8px; padding: 8px; background: #f7fafc; border-radius: 4px; border: 1px solid #e2e8f0;">
                                    <code style="color: #1a202c; word-break: break-all;">${escapeHtml(displayValue)}</code>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="list-item" style="display: block; padding: 15px; margin-bottom: 15px; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <h4 style="margin: 0; color: #1a202c;">
                                    ${name === '(æœªå‘½å)' ? 'ğŸ”§ ' : 'ğŸ“ '}${escapeHtml(name)}
                                </h4>
                                <small style="color: #a0aec0;">
                                    ${configs[0].updated_at ? `æ›´æ–°æ—¶é—´: ${new Date(configs[0].updated_at).toLocaleString('zh-CN')}` : ''}
                                </small>
                            </div>
                            ${configItems}
                        </div>
                    `;
                }).join('');
                
                configListDiv.innerHTML = configHtml;
            }
        } catch (error) {
            showError(configListDiv, `åŠ è½½å¤±è´¥: ${error.message}`);
        }
    }
</script>
{% endblock %}
