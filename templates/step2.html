{% extends "base.html" %}

{% block title %}æ­¥éª¤2: ç”ŸæˆçŸ­æ–‡ - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block step_progress %}
<div class="step-progress">
    ğŸ“ å½“å‰æ­¥éª¤ï¼šé€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡ â†’ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML
</div>
{% endblock %}

{% block content %}
<div class="section">
    <h2>æ­¥éª¤ 2: é€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡</h2>
    
    <!-- æ¨¡å¼é€‰æ‹© -->
    <div class="form-group">
        <label>ğŸ“‹ é€‰æ‹©æ¨¡å¼ï¼š</label>
        <div style="display: flex; gap: 15px; margin-top: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="mode" value="generate" checked onchange="toggleMode()" style="width: auto; margin-right: 8px;">
                <span>é€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="mode" value="custom" onchange="toggleMode()" style="width: auto; margin-right: 8px;">
                <span>è‡ªå®šä¹‰çŸ­æ–‡è¾“å…¥</span>
            </label>
        </div>
    </div>
    
    <!-- é€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡æ¨¡å¼ -->
    <div id="generateMode">
        <div class="form-group">
            <label>ğŸ“‹ é€‰æ‹©ä¸»é¢˜æŸ¥çœ‹æ ‡é¢˜ï¼š</label>
            <select id="topicSelect" onchange="loadTitles()">
                <option value="">-- é€‰æ‹©ä¸»é¢˜ --</option>
            </select>
        </div>
        <div class="form-group">
            <label>ğŸ“‹ é€‰æ‹©æç¤ºè¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <select id="articlePromptSelect">
                <option value="">ä½¿ç”¨é»˜è®¤æ¨¡æ¿</option>
            </select>
        </div>
        <div id="titlesList"></div>
        <button onclick="generateArticles()" id="generateArticlesBtn" disabled>ğŸ“„ ä¸ºé€‰ä¸­æ ‡é¢˜ç”ŸæˆçŸ­æ–‡</button>
        <div id="articlesResult"></div>
    </div>
    
    <!-- è‡ªå®šä¹‰çŸ­æ–‡è¾“å…¥æ¨¡å¼ -->
    <div id="customMode" style="display: none;">
        <div class="form-group">
            <label>ğŸ“ æ–‡ç« ä¸»é¢˜ï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™è‡ªåŠ¨åˆ›å»ºï¼‰ï¼š</label>
            <input type="text" id="customArticleTopicInput" placeholder="ä¾‹å¦‚ï¼šä¸è¦æ‹çˆ±è„‘ã€èŒåœºç”©é”…ã€æ— æ•ˆç¤¾äº¤...">
        </div>
        <div class="form-group">
            <label>ğŸ“ æ ‡é¢˜ï¼š</label>
            <input type="text" id="customArticleTitleInput" placeholder="ä¾‹å¦‚ï¼šæ„ŸåŠ¨è‡ªå·±çš„ä»˜å‡ºï¼Œæœ€å»‰ä»·ã€‚">
        </div>
        <div class="form-group">
            <label>ğŸ“„ çŸ­æ–‡å†…å®¹ï¼š</label>
            <textarea id="customArticleContentInput" rows="15" placeholder="è¯·è¾“å…¥çŸ­æ–‡å†…å®¹..."></textarea>
        </div>
        <button onclick="saveCustomArticle()">ğŸ’¾ ä¿å­˜è‡ªå®šä¹‰çŸ­æ–‡</button>
        <div id="customArticleResult"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedTitleIds = [];
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        loadPromptTemplates('article', 'articlePromptSelect');
        loadTopics();
    };
    
    // åˆ‡æ¢æ¨¡å¼
    function toggleMode() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const generateMode = document.getElementById('generateMode');
        const customMode = document.getElementById('customMode');
        
        if (mode === 'generate') {
            generateMode.style.display = 'block';
            customMode.style.display = 'none';
        } else {
            generateMode.style.display = 'none';
            customMode.style.display = 'block';
        }
    }
    
    // åŠ è½½ä¸»é¢˜åˆ—è¡¨
    async function loadTopics() {
        const select = document.getElementById('topicSelect');
        if (!select) return;
        
        try {
            const result = await apiCall('/topics');
            select.innerHTML = '<option value="">-- é€‰æ‹©ä¸»é¢˜ --</option>';
            
                if (result.data && result.data.length > 0) {
                    // åªæ˜¾ç¤ºæœ‰æ ‡é¢˜çš„ä¸»é¢˜ï¼ˆtitles_count > 0ï¼‰
                    result.data
                        .filter(topic => (topic.titles_count || 0) > 0)
                        .forEach(topic => {
                            const option = document.createElement('option');
                            option.value = topic.id;
                            option.textContent = `${topic.topic_text} (${topic.titles_count}ä¸ªæ ‡é¢˜)`;
                            select.appendChild(option);
                        });
                }
        } catch (error) {
            console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½æ ‡é¢˜åˆ—è¡¨
    async function loadTitles() {
        const topicId = document.getElementById('topicSelect').value;
        const titlesListDiv = document.getElementById('titlesList');
        
        if (!topicId) {
            titlesListDiv.innerHTML = '';
            return;
        }
        
        showLoading(titlesListDiv, 'åŠ è½½æ ‡é¢˜ä¸­...');
        
        try {
            const result = await apiCall(`/topics/${topicId}/titles`);
            selectedTitleIds = [];
            titlesListDiv.innerHTML = result.data.titles.map(title => `
                <div class="list-item" onclick="toggleTitle(${title.id})" id="title-${title.id}">
                    ${escapeHtml(title.title_text)}
                </div>
            `).join('');
            
            document.getElementById('generateArticlesBtn').disabled = false;
        } catch (error) {
            showError(titlesListDiv, `åŠ è½½å¤±è´¥: ${error.message}`);
        }
    }
    
    // åˆ‡æ¢æ ‡é¢˜é€‰æ‹©
    function toggleTitle(titleId) {
        const index = selectedTitleIds.indexOf(titleId);
        const item = document.getElementById(`title-${titleId}`);
        
        if (index > -1) {
            selectedTitleIds.splice(index, 1);
            item.classList.remove('selected');
        } else {
            selectedTitleIds.push(titleId);
            item.classList.add('selected');
        }
    }
    
    // ç”ŸæˆçŸ­æ–‡
    async function generateArticles() {
        if (selectedTitleIds.length === 0) {
            showError(document.getElementById('articlesResult'), 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ ‡é¢˜');
            return;
        }
        
        const templateId = document.getElementById('articlePromptSelect').value || null;
        const resultDiv = document.getElementById('articlesResult');
        const btn = document.getElementById('generateArticlesBtn');
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btn.disabled = true;
        showLoading(resultDiv, 'æ­£åœ¨ç”ŸæˆçŸ­æ–‡...');
        
        const results = [];
        for (const titleId of selectedTitleIds) {
            try {
                const result = await apiCall(`/titles/${titleId}/articles`, {
                    method: 'POST',
                    body: {
                        template_id: templateId ? parseInt(templateId) : null
                    }
                });
                results.push(`âœ… æ ‡é¢˜ID ${titleId}: çŸ­æ–‡å·²ç”Ÿæˆï¼ˆID: ${result.data.article_id}ï¼‰`);
            } catch (error) {
                results.push(`âŒ æ ‡é¢˜ID ${titleId}: ${error.message}`);
            }
        }
        
        resultDiv.innerHTML = `
            <div class="success">âœ… çŸ­æ–‡ç”Ÿæˆå®Œæˆï¼</div>
            <div style="margin-top: 15px;">
                ${results.map(r => `<div style="margin: 5px 0; color: #1a202c;">${escapeHtml(r)}</div>`).join('')}
            </div>
            <div style="margin-top: 20px;">
                <a href="/step3" class="next-step-btn">
                    <button>â¡ï¸ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML</button>
                </a>
            </div>
        `;
        
        btn.disabled = false;
    }
    
    // ä¿å­˜è‡ªå®šä¹‰çŸ­æ–‡
    async function saveCustomArticle() {
        const topicText = document.getElementById('customArticleTopicInput').value.trim();
        const titleText = document.getElementById('customArticleTitleInput').value.trim();
        const articleText = document.getElementById('customArticleContentInput').value.trim();
        
        if (!titleText) {
            showError(document.getElementById('customArticleResult'), 'è¯·è¾“å…¥æ ‡é¢˜');
            return;
        }
        
        if (!articleText) {
            showError(document.getElementById('customArticleResult'), 'è¯·è¾“å…¥çŸ­æ–‡å†…å®¹');
            return;
        }
        
        const resultDiv = document.getElementById('customArticleResult');
        const btn = event.target;
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btn.disabled = true;
        showLoading(resultDiv, 'æ­£åœ¨ä¿å­˜...');
        
        try {
            const result = await apiCall('/articles/custom', {
                method: 'POST',
                body: {
                    topic_text: topicText || null,
                    title_text: titleText,
                    article_text: articleText
                }
            });
            
            resultDiv.innerHTML = `
                <div class="success">âœ… è‡ªå®šä¹‰çŸ­æ–‡ä¿å­˜æˆåŠŸï¼</div>
                <div style="margin-top: 15px;">
                    <strong>ä¸»é¢˜ï¼š</strong> ${escapeHtml(result.data.topic_text || 'ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰')}<br>
                    <strong>æ ‡é¢˜IDï¼š</strong> ${result.data.title_id}<br>
                    <strong>æ ‡é¢˜ï¼š</strong> ${escapeHtml(result.data.title_text)}<br>
                    <strong>çŸ­æ–‡IDï¼š</strong> ${result.data.article_id}
                </div>
                <div style="margin-top: 20px;">
                    <a href="/step3" class="next-step-btn">
                        <button>â¡ï¸ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML</button>
                    </a>
                </div>
            `;
            // æ¸…ç©ºè¡¨å•
            document.getElementById('customArticleTopicInput').value = '';
            document.getElementById('customArticleTitleInput').value = '';
            document.getElementById('customArticleContentInput').value = '';
            
            // åˆ·æ–°ä¸»é¢˜åˆ—è¡¨
            loadTopics();
        } catch (error) {
            showError(resultDiv, `ä¿å­˜å¤±è´¥: ${error.message}`);
        } finally {
            btn.disabled = false;
        }
    }
</script>
{% endblock %}

