{% extends "base.html" %}

{% block title %}æ­¥éª¤2: ç”ŸæˆçŸ­æ–‡ - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block step_progress %}
<div class="step-progress">
    ğŸ“ å½“å‰æ­¥éª¤ï¼šé€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡ â†’ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML
</div>
{% endblock %}

{% block content %}
<div class="section">
    <h2>æ­¥éª¤ 2: é€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡</h2>
    
    <!-- æ¨¡å¼é€‰æ‹© -->
    <div class="form-group">
        <label>ğŸ“‹ é€‰æ‹©æ¨¡å¼ï¼š</label>
        <div style="display: flex; gap: 15px; margin-top: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="mode" value="generate" checked onchange="toggleMode()" style="width: auto; margin-right: 8px;">
                <span>é€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="mode" value="custom" onchange="toggleMode()" style="width: auto; margin-right: 8px;">
                <span>è‡ªå®šä¹‰çŸ­æ–‡è¾“å…¥</span>
            </label>
        </div>
    </div>
    
    <!-- é€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡æ¨¡å¼ -->
    <div id="generateMode">
        <div class="form-group">
            <label>ğŸ“‹ é€‰æ‹©ä¸»é¢˜æŸ¥çœ‹æ ‡é¢˜ï¼š</label>
            <select id="topicSelect" onchange="loadTitles()">
                <option value="">-- é€‰æ‹©ä¸»é¢˜ --</option>
            </select>
        </div>
        <div class="form-group">
            <label>ğŸ“‹ é€‰æ‹©æç¤ºè¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <select id="articlePromptSelect">
                <option value="">ä½¿ç”¨é»˜è®¤æ¨¡æ¿</option>
            </select>
        </div>
        <div id="titlesList"></div>
        <button onclick="generateArticles()" id="generateArticlesBtn" disabled>ğŸ“„ ä¸ºé€‰ä¸­æ ‡é¢˜ç”ŸæˆçŸ­æ–‡</button>
        <div id="articlesResult"></div>
    </div>
    
    <!-- è‡ªå®šä¹‰çŸ­æ–‡è¾“å…¥æ¨¡å¼ -->
    <div id="customMode" style="display: none;">
        <div class="form-group">
            <label>ğŸ“ æ–‡ç« ä¸»é¢˜ï¼ˆå¯é€‰ï¼Œä¸å¡«åˆ™è‡ªåŠ¨åˆ›å»ºï¼‰ï¼š</label>
            <input type="text" id="customArticleTopicInput" placeholder="ä¾‹å¦‚ï¼šä¸è¦æ‹çˆ±è„‘ã€èŒåœºç”©é”…ã€æ— æ•ˆç¤¾äº¤...">
        </div>
        <div class="form-group">
            <label>ğŸ“ æ ‡é¢˜ï¼š</label>
            <input type="text" id="customArticleTitleInput" placeholder="ä¾‹å¦‚ï¼šæ„ŸåŠ¨è‡ªå·±çš„ä»˜å‡ºï¼Œæœ€å»‰ä»·ã€‚">
        </div>
        <div class="form-group">
            <label>ğŸ“„ çŸ­æ–‡å†…å®¹ï¼š</label>
            <textarea id="customArticleContentInput" rows="15" placeholder="è¯·è¾“å…¥çŸ­æ–‡å†…å®¹..."></textarea>
        </div>
        <button onclick="saveCustomArticle()">ğŸ’¾ ä¿å­˜è‡ªå®šä¹‰çŸ­æ–‡</button>
        <div id="customArticleResult"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedTitleIds = [];
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        loadPromptTemplates('article', 'articlePromptSelect');
        loadTopics();
    };
    
    // åˆ‡æ¢æ¨¡å¼
    function toggleMode() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const generateMode = document.getElementById('generateMode');
        const customMode = document.getElementById('customMode');
        
        if (mode === 'generate') {
            generateMode.style.display = 'block';
            customMode.style.display = 'none';
        } else {
            generateMode.style.display = 'none';
            customMode.style.display = 'block';
        }
    }
    
    // åŠ è½½ä¸»é¢˜åˆ—è¡¨
    async function loadTopics() {
        try {
            const response = await fetch('/api/topics');
            const result = await response.json();
            
            if (result.success) {
                const select = document.getElementById('topicSelect');
                select.innerHTML = '<option value="">-- é€‰æ‹©ä¸»é¢˜ --</option>';
                
                if (result.data && result.data.length > 0) {
                    result.data.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic.id;
                        option.textContent = `${topic.topic_text} (${topic.titles_count || 0}ä¸ªæ ‡é¢˜)`;
                        select.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('åŠ è½½ä¸»é¢˜å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½æ ‡é¢˜åˆ—è¡¨
    async function loadTitles() {
        const topicId = document.getElementById('topicSelect').value;
        if (!topicId) {
            document.getElementById('titlesList').innerHTML = '';
            return;
        }
        
        const titlesListDiv = document.getElementById('titlesList');
        titlesListDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­</div>';
        
        try {
            const response = await fetch(`/api/topics/${topicId}/titles`);
            const result = await response.json();
            
            if (result.success) {
                selectedTitleIds = [];
                titlesListDiv.innerHTML = result.data.titles.map(title => `
                    <div class="list-item" onclick="toggleTitle(${title.id})" id="title-${title.id}">
                        ${title.title_text}
                    </div>
                `).join('');
                
                document.getElementById('generateArticlesBtn').disabled = false;
            } else {
                titlesListDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
            }
        } catch (error) {
            titlesListDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
    }
    
    // åˆ‡æ¢æ ‡é¢˜é€‰æ‹©
    function toggleTitle(titleId) {
        const index = selectedTitleIds.indexOf(titleId);
        const item = document.getElementById(`title-${titleId}`);
        
        if (index > -1) {
            selectedTitleIds.splice(index, 1);
            item.classList.remove('selected');
        } else {
            selectedTitleIds.push(titleId);
            item.classList.add('selected');
        }
    }
    
    // ç”ŸæˆçŸ­æ–‡
    async function generateArticles() {
        if (selectedTitleIds.length === 0) {
            alert('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ ‡é¢˜');
            return;
        }
        
        const templateId = document.getElementById('articlePromptSelect').value || null;
        const resultDiv = document.getElementById('articlesResult');
        resultDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”ŸæˆçŸ­æ–‡</div>';
        
        const results = [];
        for (const titleId of selectedTitleIds) {
            try {
                const response = await fetch(`/api/titles/${titleId}/articles`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        template_id: templateId ? parseInt(templateId) : null
                    })
                });
                const result = await response.json();
                
                if (result.success) {
                    results.push(`âœ… æ ‡é¢˜ID ${titleId}: çŸ­æ–‡å·²ç”Ÿæˆï¼ˆID: ${result.data.article_id}ï¼‰`);
                } else {
                    results.push(`âŒ æ ‡é¢˜ID ${titleId}: ${result.error}`);
                }
            } catch (error) {
                results.push(`âŒ æ ‡é¢˜ID ${titleId}: ${error.message}`);
            }
        }
        
        resultDiv.innerHTML = `
            <div class="success">âœ… çŸ­æ–‡ç”Ÿæˆå®Œæˆï¼</div>
            <div style="margin-top: 15px;">
                ${results.map(r => `<div style="margin: 5px 0; color: #1a202c;">${r}</div>`).join('')}
            </div>
            <div style="margin-top: 20px;">
                <a href="/step3" class="next-step-btn">
                    <button>â¡ï¸ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML</button>
                </a>
            </div>
        `;
    }
    
    // ä¿å­˜è‡ªå®šä¹‰çŸ­æ–‡
    async function saveCustomArticle() {
        const topicText = document.getElementById('customArticleTopicInput').value.trim();
        const titleText = document.getElementById('customArticleTitleInput').value.trim();
        const articleText = document.getElementById('customArticleContentInput').value.trim();
        
        if (!titleText) {
            alert('è¯·è¾“å…¥æ ‡é¢˜');
            return;
        }
        
        if (!articleText) {
            alert('è¯·è¾“å…¥çŸ­æ–‡å†…å®¹');
            return;
        }
        
        const resultDiv = document.getElementById('customArticleResult');
        resultDiv.innerHTML = '<div class="loading">æ­£åœ¨ä¿å­˜...</div>';
        
        try {
            const response = await fetch('/api/articles/custom', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    topic_text: topicText || null,
                    title_text: titleText,
                    article_text: articleText
                })
            });
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="success">âœ… è‡ªå®šä¹‰çŸ­æ–‡ä¿å­˜æˆåŠŸï¼</div>
                    <div style="margin-top: 15px;">
                        <strong>ä¸»é¢˜ï¼š</strong> ${result.data.topic_text || 'ï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰'}<br>
                        <strong>æ ‡é¢˜IDï¼š</strong> ${result.data.title_id}<br>
                        <strong>æ ‡é¢˜ï¼š</strong> ${result.data.title_text}<br>
                        <strong>çŸ­æ–‡IDï¼š</strong> ${result.data.article_id}
                    </div>
                    <div style="margin-top: 20px;">
                        <a href="/step3" class="next-step-btn">
                            <button>â¡ï¸ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML</button>
                        </a>
                    </div>
                `;
                // æ¸…ç©ºè¡¨å•
                document.getElementById('customArticleTopicInput').value = '';
                document.getElementById('customArticleTitleInput').value = '';
                document.getElementById('customArticleContentInput').value = '';
                
                // åˆ·æ–°ä¸»é¢˜åˆ—è¡¨
                loadTopics();
            } else {
                resultDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">âŒ ä¿å­˜å¤±è´¥: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}

