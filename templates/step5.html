{% extends "base.html" %}

{% block title %}æ­¥éª¤5: è°ƒç”¨Coze API - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block step_progress %}
<div class="step-progress">
    ğŸ“ å½“å‰æ­¥éª¤ï¼šé€‰æ‹©æ ‡é¢˜ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API
</div>
{% endblock %}

{% block content %}
<div class="section">
    <h2>æ­¥éª¤ 5: é€‰æ‹©æ ‡é¢˜ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API</h2>
    <div class="form-group">
        <label>ğŸ“‹ é€‰æ‹©ä¸»é¢˜æŸ¥çœ‹æ ‡é¢˜ï¼š</label>
        <select id="cozeTopicSelect" onchange="loadCozeTitles()">
            <option value="">-- é€‰æ‹©ä¸»é¢˜ --</option>
        </select>
    </div>
    <div class="form-group">
        <label>ğŸ“‹ é€‰æ‹©æç¤ºè¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ï¼š</label>
        <select id="cozeHtmlPromptSelect">
            <option value="">ä½¿ç”¨é»˜è®¤æ¨¡æ¿</option>
        </select>
    </div>
    <div id="cozeTitlesList"></div>
    <button onclick="generateHTMLAndCallCoze()" id="generateCozeBtn" disabled>ğŸš€ ä¸ºé€‰ä¸­æ ‡é¢˜ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API</button>
    <div id="cozeResult"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedCozeTitleId = null;
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        loadPromptTemplates('html', 'cozeHtmlPromptSelect');
        loadCozeTopics();
    };
    
    // åŠ è½½Cozeä¸»é¢˜åˆ—è¡¨ï¼ˆå¤ç”¨ä¸»é¢˜æ•°æ®ï¼‰
    async function loadCozeTopics() {
        const select = document.getElementById('cozeTopicSelect');
        if (!select) return;
        
        try {
            const result = await apiCall('/topics');
            select.innerHTML = '<option value="">-- é€‰æ‹©ä¸»é¢˜ --</option>';
            
                if (result.data && result.data.length > 0) {
                    // åªæ˜¾ç¤ºæœ‰æ ‡é¢˜çš„ä¸»é¢˜ï¼ˆtitles_count > 0ï¼‰
                    result.data
                        .filter(topic => (topic.titles_count || 0) > 0)
                        .forEach(topic => {
                            const option = document.createElement('option');
                            option.value = topic.id;
                            option.textContent = `${topic.topic_text} (${topic.titles_count}ä¸ªæ ‡é¢˜)`;
                            select.appendChild(option);
                        });
                }
        } catch (error) {
            console.error('åŠ è½½Cozeä¸»é¢˜å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½Cozeæ ‡é¢˜åˆ—è¡¨
    async function loadCozeTitles() {
        const topicId = document.getElementById('cozeTopicSelect').value;
        const titlesListDiv = document.getElementById('cozeTitlesList');
        
        if (!topicId) {
            titlesListDiv.innerHTML = '';
            return;
        }
        
        showLoading(titlesListDiv, 'åŠ è½½ä¸­...');
        
        try {
            const result = await apiCall(`/topics/${topicId}/titles`);
            titlesListDiv.innerHTML = result.data.titles.map(title => `
                <div class="list-item" onclick="selectCozeTitle(${title.id})" id="coze-title-${title.id}">
                    ${escapeHtml(title.title_text)}
                </div>
            `).join('');
            
            document.getElementById('generateCozeBtn').disabled = false;
        } catch (error) {
            showError(titlesListDiv, `åŠ è½½å¤±è´¥: ${error.message}`);
        }
    }
    
    // é€‰æ‹©Cozeæ ‡é¢˜
    function selectCozeTitle(titleId) {
        selectedCozeTitleId = titleId;
        
        document.querySelectorAll('#cozeTitlesList .list-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.getElementById(`coze-title-${titleId}`).classList.add('selected');
        
        document.getElementById('generateCozeBtn').disabled = false;
    }
    
    // ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API
    async function generateHTMLAndCallCoze() {
        if (!selectedCozeTitleId) {
            showError(document.getElementById('cozeResult'), 'è¯·é€‰æ‹©ä¸€ä¸ªæ ‡é¢˜');
            return;
        }
        
        const htmlTemplateId = document.getElementById('cozeHtmlPromptSelect').value || null;
        const resultDiv = document.getElementById('cozeResult');
        const btn = document.getElementById('generateCozeBtn');
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btn.disabled = true;
        showLoading(resultDiv, 'æ­£åœ¨ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API...');
        
        try {
            const result = await apiCall(`/titles/${selectedCozeTitleId}/coze`, {
                method: 'POST',
                body: {
                    html_template_id: htmlTemplateId ? parseInt(htmlTemplateId) : null
                }
            });
            
            // æ ¼å¼åŒ– Coze API å“åº”
            let cozeResultHtml = '';
            const cozeResult = result.data.coze_result;
            
            if (cozeResult) {
                if (cozeResult.response_type === 'text') {
                    // æ–‡æœ¬å“åº”
                    cozeResultHtml = `
                        <div style="color: #1a202c; margin-bottom: 10px;"><strong style="color: #2d3748;">å“åº”ç±»å‹:</strong> <span style="color: #1a202c;">æ–‡æœ¬ (${cozeResult.full_length} å­—ç¬¦)</span></div>
                        <pre style="background: #f7fafc; color: #1a202c !important; padding: 15px; border-radius: 4px; overflow-x: auto; margin-top: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; font-size: 13px; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(cozeResult.content)}</pre>
                    `;
                } else if (cozeResult.stream_data) {
                    // SSE æµå¼æ•°æ®
                    cozeResultHtml = `
                        <div style="color: #1a202c; margin-bottom: 10px;"><strong style="color: #2d3748;">å“åº”ç±»å‹:</strong> <span style="color: #1a202c;">æµå¼æ•°æ® (${cozeResult.stream_data.length} æ¡)</span></div>
                        <pre style="background: #f7fafc; color: #1a202c !important; padding: 15px; border-radius: 4px; overflow-x: auto; margin-top: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; font-size: 13px; line-height: 1.5;">${escapeHtml(JSON.stringify(cozeResult.stream_data, null, 2))}</pre>
                    `;
                } else {
                    // JSON å“åº”
                    cozeResultHtml = `
                        <div style="color: #1a202c; margin-bottom: 10px;"><strong style="color: #2d3748;">å“åº”ç±»å‹:</strong> <span style="color: #1a202c;">JSON</span></div>
                        <pre style="background: #f7fafc; color: #1a202c !important; padding: 15px; border-radius: 4px; overflow-x: auto; margin-top: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; font-size: 13px; line-height: 1.5;">${escapeHtml(JSON.stringify(cozeResult, null, 2))}</pre>
                    `;
                }
            } else {
                cozeResultHtml = '<div style="color: #1a202c;">æ— å“åº”æ•°æ®</div>';
            }
            
            resultDiv.innerHTML = `
                <div class="success">âœ… æˆåŠŸï¼HTMLå·²ç”Ÿæˆå¹¶è°ƒç”¨Coze API</div>
                <div style="margin-top: 15px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <div style="color: #1a202c; margin-bottom: 10px;"><strong style="color: #2d3748;">æ ‡é¢˜:</strong> <span style="color: #1a202c;">${escapeHtml(result.data.title_text)}</span></div>
                    <div style="color: #1a202c; margin-bottom: 10px;"><strong style="color: #2d3748;">HTML ID:</strong> <span style="color: #1a202c;">${result.data.html_id}</span></div>
                    <div style="color: #1a202c; margin-bottom: 10px;"><strong style="color: #2d3748;">Coze APIå“åº”:</strong></div>
                    ${cozeResultHtml}
                </div>
            `;
        } catch (error) {
            showError(resultDiv, `ç”Ÿæˆå¤±è´¥: ${error.message}`);
        } finally {
            btn.disabled = false;
        }
    }
</script>
{% endblock %}

