{% extends "base.html" %}

{% block title %}æ­¥éª¤5: è°ƒç”¨Coze API - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block step_progress %}
<div class="step-progress">
    ğŸ“ å½“å‰æ­¥éª¤ï¼šé€‰æ‹©æ ‡é¢˜ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API
</div>
{% endblock %}

{% block content %}
<div class="section">
    <h2>æ­¥éª¤ 5: é€‰æ‹©æ ‡é¢˜ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API</h2>
    <div class="form-group">
        <label>ğŸ“‹ é€‰æ‹©ä¸»é¢˜æŸ¥çœ‹æ ‡é¢˜ï¼š</label>
        <select id="cozeTopicSelect" onchange="loadCozeTitles()">
            <option value="">-- é€‰æ‹©ä¸»é¢˜ --</option>
        </select>
    </div>
    <div class="form-group">
        <label>ğŸ“‹ é€‰æ‹©æç¤ºè¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ï¼š</label>
        <select id="cozeHtmlPromptSelect">
            <option value="">ä½¿ç”¨é»˜è®¤æ¨¡æ¿</option>
        </select>
    </div>
    <div id="cozeTitlesList"></div>
    <button onclick="generateHTMLAndCallCoze()" id="generateCozeBtn" disabled>ğŸš€ ä¸ºé€‰ä¸­æ ‡é¢˜ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API</button>
    <div id="cozeResult"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedCozeTitleId = null;
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        loadPromptTemplates('html', 'cozeHtmlPromptSelect');
        loadCozeTopics();
    };
    
    // åŠ è½½Cozeä¸»é¢˜åˆ—è¡¨ï¼ˆå¤ç”¨ä¸»é¢˜æ•°æ®ï¼‰
    async function loadCozeTopics() {
        try {
            const response = await fetch('/api/topics');
            const result = await response.json();
            
            if (result.success) {
                const select = document.getElementById('cozeTopicSelect');
                select.innerHTML = '<option value="">-- é€‰æ‹©ä¸»é¢˜ --</option>';
                
                if (result.data && result.data.length > 0) {
                    result.data.forEach(topic => {
                        const option = document.createElement('option');
                        option.value = topic.id;
                        option.textContent = `${topic.topic_text} (${topic.titles_count || 0}ä¸ªæ ‡é¢˜)`;
                        select.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('åŠ è½½Cozeä¸»é¢˜å¤±è´¥:', error);
        }
    }
    
    // åŠ è½½Cozeæ ‡é¢˜åˆ—è¡¨
    async function loadCozeTitles() {
        const topicId = document.getElementById('cozeTopicSelect').value;
        if (!topicId) {
            document.getElementById('cozeTitlesList').innerHTML = '';
            return;
        }
        
        const titlesListDiv = document.getElementById('cozeTitlesList');
        titlesListDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­</div>';
        
        try {
            const response = await fetch(`/api/topics/${topicId}/titles`);
            const result = await response.json();
            
            if (result.success) {
                titlesListDiv.innerHTML = result.data.titles.map(title => `
                    <div class="list-item" onclick="selectCozeTitle(${title.id})" id="coze-title-${title.id}">
                        ${title.title_text}
                    </div>
                `).join('');
                
                document.getElementById('generateCozeBtn').disabled = false;
            } else {
                titlesListDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
            }
        } catch (error) {
            titlesListDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
    }
    
    // é€‰æ‹©Cozeæ ‡é¢˜
    function selectCozeTitle(titleId) {
        selectedCozeTitleId = titleId;
        
        document.querySelectorAll('#cozeTitlesList .list-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.getElementById(`coze-title-${titleId}`).classList.add('selected');
        
        document.getElementById('generateCozeBtn').disabled = false;
    }
    
    // ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API
    async function generateHTMLAndCallCoze() {
        if (!selectedCozeTitleId) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªæ ‡é¢˜');
            return;
        }
        
        const htmlTemplateId = document.getElementById('cozeHtmlPromptSelect').value || null;
        
        const resultDiv = document.getElementById('cozeResult');
        resultDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”ŸæˆHTMLå¹¶è°ƒç”¨Coze API</div>';
        
        try {
            const response = await fetch(`/api/titles/${selectedCozeTitleId}/coze`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    html_template_id: htmlTemplateId ? parseInt(htmlTemplateId) : null
                })
            });
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="success">âœ… æˆåŠŸï¼HTMLå·²ç”Ÿæˆå¹¶è°ƒç”¨Coze API</div>
                    <div style="margin-top: 15px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <div style="color: #1a202c; margin-bottom: 10px;"><strong style="color: #2d3748;">æ ‡é¢˜:</strong> <span style="color: #1a202c;">${result.data.title_text}</span></div>
                        <div style="color: #1a202c; margin-bottom: 10px;"><strong style="color: #2d3748;">HTML ID:</strong> <span style="color: #1a202c;">${result.data.html_id}</span></div>
                        <div style="color: #1a202c; margin-bottom: 10px;"><strong style="color: #2d3748;">Coze APIå“åº”:</strong></div>
                        <pre style="background: #f7fafc; color: #1a202c !important; padding: 15px; border-radius: 4px; overflow-x: auto; margin-top: 10px; max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; font-size: 13px; line-height: 1.5;">${JSON.stringify(result.data.coze_result, null, 2)}</pre>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">âŒ ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}

