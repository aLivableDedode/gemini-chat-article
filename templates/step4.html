{% extends "base.html" %}

{% block title %}æ­¥éª¤4: æŸ¥çœ‹HTMLè¾“å‡º - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block step_progress %}
<div class="step-progress">
    ğŸ“ å½“å‰æ­¥éª¤ï¼šæŸ¥çœ‹HTMLè¾“å‡º â†’ å¯é€‰ï¼šè°ƒç”¨Coze API
</div>
{% endblock %}

{% block content %}
<div class="section">
    <h2>æ­¥éª¤ 4: æŸ¥çœ‹HTMLè¾“å‡º</h2>
    <button onclick="loadHTMLOutputs()">ğŸ”„ åˆ·æ–°HTMLåˆ—è¡¨</button>
    <div id="htmlOutputsList"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        loadHTMLOutputs();
    };
    
    // åŠ è½½HTMLè¾“å‡ºåˆ—è¡¨ï¼ˆä»…æ˜¾ç¤ºåˆ—è¡¨ï¼Œä¸åŠ è½½å†…å®¹ï¼‰
    async function loadHTMLOutputs() {
        const htmlListDiv = document.getElementById('htmlOutputsList');
        htmlListDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­</div>';
        
        try {
            const response = await fetch('/api/html');
            const result = await response.json();
            
            if (result.success) {
                if (result.data.length === 0) {
                    htmlListDiv.innerHTML = '<div class="info">æš‚æ— HTMLè¾“å‡ºï¼Œè¯·å…ˆå®Œæˆæ­¥éª¤3</div>';
                } else {
                    htmlListDiv.innerHTML = result.data.map(html => `
                        <div class="html-output-item" style="margin-bottom: 15px; padding: 20px; background: #ffffff; border-radius: 12px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; transition: all 0.3s ease;" onclick="toggleHTMLOutput(${html.id}, this)">
                            <div style="color: #2d3748; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="color: #1a202c;">ID:</strong> <span style="color: #1a202c;">${html.id}</span> | 
                                    <strong style="color: #1a202c;">çŸ­æ–‡:</strong> <span style="color: #1a202c;">${html.article_title}</span>
                                </div>
                                <div style="color: #667eea; font-size: 14px;">
                                    <span class="expand-icon-${html.id}">â–¼</span> <span class="expand-text-${html.id}">ç‚¹å‡»å±•å¼€</span>
                                </div>
                            </div>
                            <div id="html-content-${html.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid #e2e8f0;">
                                <div class="loading-small">åŠ è½½ä¸­...</div>
                            </div>
                        </div>
                    `).join('');
                }
            } else {
                htmlListDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
            }
        } catch (error) {
            htmlListDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
    }
    
    // åˆ‡æ¢HTMLè¾“å‡ºå†…å®¹çš„æ˜¾ç¤º/éšè—
    async function toggleHTMLOutput(htmlId, element) {
        const contentDiv = document.getElementById(`html-content-${htmlId}`);
        const iconSpan = element.querySelector(`.expand-icon-${htmlId}`);
        const textSpan = element.querySelector(`.expand-text-${htmlId}`);
        
        // å¦‚æœå·²ç»å±•å¼€ï¼Œç›´æ¥æŠ˜å 
        if (contentDiv.style.display !== 'none') {
            contentDiv.style.display = 'none';
            iconSpan.textContent = 'â–¼';
            textSpan.textContent = 'ç‚¹å‡»å±•å¼€';
            return;
        }
        
        // å¦‚æœå†…å®¹è¿˜æ²¡æœ‰åŠ è½½ï¼Œå…ˆåŠ è½½
        if (contentDiv.innerHTML.includes('åŠ è½½ä¸­')) {
            try {
                const response = await fetch(`/api/html/${htmlId}`);
                const result = await response.json();
                
                if (result.success) {
                    contentDiv.innerHTML = `<div class="html-preview" style="color: #1a202c;">${result.data.html_content}</div>`;
                    contentDiv.style.display = 'block';
                    iconSpan.textContent = 'â–²';
                    textSpan.textContent = 'ç‚¹å‡»æ”¶èµ·';
                } else {
                    contentDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
                    contentDiv.style.display = 'block';
                }
            } catch (error) {
                contentDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
                contentDiv.style.display = 'block';
            }
        } else {
            // å†…å®¹å·²åŠ è½½ï¼Œç›´æ¥åˆ‡æ¢æ˜¾ç¤º
            contentDiv.style.display = 'block';
            iconSpan.textContent = 'â–²';
            textSpan.textContent = 'ç‚¹å‡»æ”¶èµ·';
        }
    }
</script>
{% endblock %}

