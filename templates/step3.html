{% extends "base.html" %}

{% block title %}æ­¥éª¤3: ç”ŸæˆHTML - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block step_progress %}
<div class="step-progress">
    ğŸ“ å½“å‰æ­¥éª¤ï¼šé€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML â†’ ä¸‹ä¸€æ­¥ï¼šæŸ¥çœ‹HTMLè¾“å‡º
</div>
{% endblock %}

{% block content %}
<div class="section">
    <h2>æ­¥éª¤ 3: é€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML</h2>
    <div class="form-group">
        <label>ğŸ“‹ é€‰æ‹©æç¤ºè¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ï¼š</label>
        <select id="htmlPromptSelect">
            <option value="">ä½¿ç”¨é»˜è®¤æ¨¡æ¿</option>
        </select>
    </div>
    <div id="articlesList"></div>
    <button onclick="generateHTML()" id="generateHTMLBtn" disabled>ğŸ¨ ä¸ºé€‰ä¸­çŸ­æ–‡ç”ŸæˆHTML</button>
    <div id="htmlResult"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedArticleId = null;
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        loadPromptTemplates('html', 'htmlPromptSelect');
        loadArticles();
    };
    
    // åŠ è½½çŸ­æ–‡åˆ—è¡¨
    async function loadArticles() {
        const articlesListDiv = document.getElementById('articlesList');
        articlesListDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­</div>';
        
        try {
            const response = await fetch('/api/articles');
            const result = await response.json();
            
            if (result.success) {
                if (result.data.length === 0) {
                    articlesListDiv.innerHTML = '<div class="info">æš‚æ— çŸ­æ–‡ï¼Œè¯·å…ˆå®Œæˆæ­¥éª¤2</div>';
                } else {
                    articlesListDiv.innerHTML = result.data.map(article => `
                        <div class="list-item" onclick="selectArticle(${article.id})" id="article-${article.id}">
                            <strong>${article.title_text}</strong>
                            <small style="display: block; margin-top: 5px; color: #718096;">${article.article_text ? article.article_text.substring(0, 100) + '...' : 'æš‚æ— å†…å®¹'}</small>
                        </div>
                    `).join('');
                }
            }
        } catch (error) {
            articlesListDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
    }
    
    // é€‰æ‹©çŸ­æ–‡
    function selectArticle(articleId) {
        selectedArticleId = articleId;
        
        document.querySelectorAll('#articlesList .list-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.getElementById(`article-${articleId}`).classList.add('selected');
        
        document.getElementById('generateHTMLBtn').disabled = false;
    }
    
    // ç”ŸæˆHTML
    async function generateHTML() {
        if (!selectedArticleId) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªçŸ­æ–‡');
            return;
        }
        
        const templateId = document.getElementById('htmlPromptSelect').value || null;
        const resultDiv = document.getElementById('htmlResult');
        resultDiv.innerHTML = '<div class="loading">æ­£åœ¨ç”ŸæˆHTML</div>';
        
        try {
            const response = await fetch(`/api/articles/${selectedArticleId}/html`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    template_id: templateId ? parseInt(templateId) : null
                })
            });
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="success">âœ… HTMLå·²ç”Ÿæˆï¼ˆID: ${result.data.html_id}ï¼‰</div>
                    <div class="html-preview" style="color: #1a202c;">${result.data.html_content}</div>
                    <div style="margin-top: 20px;">
                        <a href="/step4" class="next-step-btn">
                            <button>â¡ï¸ ä¸‹ä¸€æ­¥ï¼šæŸ¥çœ‹HTMLè¾“å‡º</button>
                        </a>
                    </div>
                `;
                loadArticles();
            } else {
                resultDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">âŒ ç”Ÿæˆå¤±è´¥: ${error.message}</div>`;
        }
    }
</script>
{% endblock %}

