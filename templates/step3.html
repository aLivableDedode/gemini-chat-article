{% extends "base.html" %}

{% block title %}æ­¥éª¤3: ç”ŸæˆHTML - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block step_progress %}
<div class="step-progress">
    ğŸ“ å½“å‰æ­¥éª¤ï¼šé€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML â†’ ä¸‹ä¸€æ­¥ï¼šæŸ¥çœ‹HTMLè¾“å‡º
</div>
{% endblock %}

{% block content %}
<div class="section">
    <h2>æ­¥éª¤ 3: é€‰æ‹©çŸ­æ–‡ç”ŸæˆHTML</h2>
    <div class="form-group">
        <label>ğŸ“‹ é€‰æ‹©æç¤ºè¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ï¼š</label>
        <select id="htmlPromptSelect">
            <option value="">ä½¿ç”¨é»˜è®¤æ¨¡æ¿</option>
        </select>
    </div>
    <div id="articlesList"></div>
    <button onclick="generateHTML()" id="generateHTMLBtn" disabled>ğŸ¨ ä¸ºé€‰ä¸­çŸ­æ–‡ç”ŸæˆHTML</button>
    <div id="htmlResult"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let selectedArticleId = null;
    
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        loadPromptTemplates('html', 'htmlPromptSelect');
        loadArticles();
    };
    
    // åŠ è½½çŸ­æ–‡åˆ—è¡¨
    async function loadArticles() {
        const articlesListDiv = document.getElementById('articlesList');
        showLoading(articlesListDiv, 'åŠ è½½ä¸­...');
        
        try {
            const result = await apiCall('/articles');
            
            if (result.data.length === 0) {
                articlesListDiv.innerHTML = '<div class="info">æš‚æ— çŸ­æ–‡ï¼Œè¯·å…ˆå®Œæˆæ­¥éª¤2</div>';
            } else {
                articlesListDiv.innerHTML = result.data.map(article => `
                    <div class="list-item" onclick="selectArticle(${article.id})" id="article-${article.id}">
                        <strong>${escapeHtml(article.title_text)}</strong>
                        <small style="display: block; margin-top: 5px; color: #718096;">${escapeHtml(article.article_text ? article.article_text.substring(0, 100) + '...' : 'æš‚æ— å†…å®¹')}</small>
                    </div>
                `).join('');
            }
        } catch (error) {
            showError(articlesListDiv, `åŠ è½½å¤±è´¥: ${error.message}`);
        }
    }
    
    // é€‰æ‹©çŸ­æ–‡
    function selectArticle(articleId) {
        selectedArticleId = articleId;
        
        document.querySelectorAll('#articlesList .list-item').forEach(item => {
            item.classList.remove('selected');
        });
        document.getElementById(`article-${articleId}`).classList.add('selected');
        
        document.getElementById('generateHTMLBtn').disabled = false;
    }
    
    // ç”ŸæˆHTML
    async function generateHTML() {
        if (!selectedArticleId) {
            showError(document.getElementById('htmlResult'), 'è¯·é€‰æ‹©ä¸€ä¸ªçŸ­æ–‡');
            return;
        }
        
        const templateId = document.getElementById('htmlPromptSelect').value || null;
        const resultDiv = document.getElementById('htmlResult');
        const btn = document.getElementById('generateHTMLBtn');
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btn.disabled = true;
        showLoading(resultDiv, 'æ­£åœ¨ç”ŸæˆHTML...');
        
        try {
            const result = await apiCall(`/articles/${selectedArticleId}/html`, {
                method: 'POST',
                body: {
                    template_id: templateId ? parseInt(templateId) : null
                }
            });
            
            resultDiv.innerHTML = `
                <div class="success">âœ… HTMLå·²ç”Ÿæˆï¼ˆID: ${result.data.html_id}ï¼‰</div>
                <div class="html-preview" style="color: #1a202c;">${result.data.html_content}</div>
                <div style="margin-top: 20px;">
                    <a href="/step4" class="next-step-btn">
                        <button>â¡ï¸ ä¸‹ä¸€æ­¥ï¼šæŸ¥çœ‹HTMLè¾“å‡º</button>
                    </a>
                </div>
            `;
            loadArticles();
        } catch (error) {
            showError(resultDiv, `ç”Ÿæˆå¤±è´¥: ${error.message}`);
        } finally {
            btn.disabled = false;
        }
    }
</script>
{% endblock %}

