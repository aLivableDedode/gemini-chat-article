{% extends "base.html" %}

{% block title %}æç¤ºè¯ç®¡ç† - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="section">
    <h2>ğŸ“ æç¤ºè¯ç®¡ç†</h2>
    
    <!-- æ·»åŠ æç¤ºè¯è¡¨å• -->
    <div style="margin-bottom: 30px; padding: 20px; background: #f7fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
        <h3 style="margin-bottom: 15px; color: #1a202c;">â• æ·»åŠ æ–°æç¤ºè¯</h3>
        <div class="form-group">
            <label>ğŸ“‹ åˆ†ç±»ï¼š</label>
            <select id="addPromptCategory">
                <option value="">-- é€‰æ‹©åˆ†ç±» --</option>
                <option value="title">æ ‡é¢˜æç¤ºè¯</option>
                <option value="article">çŸ­æ–‡æç¤ºè¯</option>
                <option value="html">HTMLæç¤ºè¯</option>
            </select>
        </div>
        <div class="form-group">
            <label>ğŸ“ æ¨¡æ¿åç§°ï¼š</label>
            <input type="text" id="addPromptName" placeholder="ä¾‹å¦‚ï¼šé»˜è®¤æ ‡é¢˜æ¨¡æ¿ã€æƒ…æ„Ÿç±»æ ‡é¢˜æ¨¡æ¿...">
        </div>
        <div class="form-group">
            <label>ğŸ“„ æ¨¡æ¿æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="text" id="addPromptDescription" placeholder="ç®€è¦æè¿°è¿™ä¸ªæ¨¡æ¿çš„ç”¨é€”...">
        </div>
        <div class="form-group">
            <label>ğŸ“ æ¨¡æ¿å†…å®¹ï¼š</label>
            <textarea id="addPromptContent" rows="12" placeholder="è¯·è¾“å…¥æç¤ºè¯æ¨¡æ¿å†…å®¹...&#10;&#10;å¯ä»¥ä½¿ç”¨å ä½ç¬¦ï¼š&#10;- {{topic}} ç”¨äºæ ‡é¢˜ç”Ÿæˆ&#10;- {{content}} ç”¨äºHTMLç”Ÿæˆ"></textarea>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="addPromptIsDefault" style="width: auto; margin-right: 8px;">
                <span>è®¾ä¸ºé»˜è®¤æ¨¡æ¿</span>
            </label>
        </div>
        <button onclick="addPrompt()">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
        <div id="addPromptResult" style="margin-top: 15px;"></div>
    </div>
    
    <!-- æŸ¥çœ‹æç¤ºè¯åˆ—è¡¨ -->
    <div style="margin-top: 30px;">
        <h3 style="margin-bottom: 15px; color: #1a202c;">ğŸ“‹ æŸ¥çœ‹æç¤ºè¯åˆ—è¡¨</h3>
        <div class="form-group">
            <label>é€‰æ‹©æŸ¥çœ‹ç±»å‹ï¼š</label>
            <select id="promptTypeSelect" onchange="loadPrompts()">
                <option value="">-- é€‰æ‹©ç±»å‹ --</option>
                <option value="titles">æ ‡é¢˜æç¤ºè¯</option>
                <option value="articles">çŸ­æ–‡æç¤ºè¯</option>
                <option value="html">HTMLæç¤ºè¯</option>
            </select>
        </div>
        <div id="promptsList"></div>
        <div id="promptDetail" style="display: none; margin-top: 20px; padding: 20px; background: #f7fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
            <button onclick="closePromptDetail()" style="background: #718096; margin-bottom: 15px;">å…³é—­</button>
            <div id="promptContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // æ·»åŠ æç¤ºè¯
    async function addPrompt() {
        const category = document.getElementById('addPromptCategory').value;
        const name = document.getElementById('addPromptName').value.trim();
        const description = document.getElementById('addPromptDescription').value.trim();
        const content = document.getElementById('addPromptContent').value.trim();
        const isDefault = document.getElementById('addPromptIsDefault').checked;
        
        if (!category) {
            showError(document.getElementById('addPromptResult'), 'è¯·é€‰æ‹©åˆ†ç±»');
            return;
        }
        
        if (!name) {
            showError(document.getElementById('addPromptResult'), 'è¯·è¾“å…¥æ¨¡æ¿åç§°');
            return;
        }
        
        if (!content) {
            showError(document.getElementById('addPromptResult'), 'è¯·è¾“å…¥æ¨¡æ¿å†…å®¹');
            return;
        }
        
        const resultDiv = document.getElementById('addPromptResult');
        const btn = event.target;
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btn.disabled = true;
        showLoading(resultDiv, 'æ­£åœ¨ä¿å­˜...');
        
        try {
            const result = await apiCall('/prompts', {
                method: 'POST',
                body: {
                    category: category,
                    name: name,
                    description: description || null,
                    content: content,
                    is_default: isDefault
                }
            });
            
            resultDiv.innerHTML = `
                <div class="success">âœ… æç¤ºè¯ä¿å­˜æˆåŠŸï¼</div>
                <div style="margin-top: 10px;">
                    <strong>æ¨¡æ¿ID:</strong> ${result.data.id}<br>
                    <strong>åˆ†ç±»:</strong> ${escapeHtml(result.data.category)}<br>
                    <strong>åç§°:</strong> ${escapeHtml(result.data.name)}
                </div>
            `;
            // æ¸…ç©ºè¡¨å•
            document.getElementById('addPromptCategory').value = '';
            document.getElementById('addPromptName').value = '';
            document.getElementById('addPromptDescription').value = '';
            document.getElementById('addPromptContent').value = '';
            document.getElementById('addPromptIsDefault').checked = false;
            
            // å¦‚æœå½“å‰æŸ¥çœ‹çš„ç±»å‹åŒ¹é…ï¼Œåˆ·æ–°åˆ—è¡¨
            const currentType = document.getElementById('promptTypeSelect').value;
            if (currentType && (
                (currentType === 'titles' && category === 'title') ||
                (currentType === 'articles' && category === 'article') ||
                (currentType === 'html' && category === 'html')
            )) {
                loadPrompts();
            }
        } catch (error) {
            showError(resultDiv, `ä¿å­˜å¤±è´¥: ${error.message}`);
        } finally {
            btn.disabled = false;
        }
    }
    
    // åŠ è½½æç¤ºè¯åˆ—è¡¨
    async function loadPrompts() {
        const type = document.getElementById('promptTypeSelect').value;
        const promptsListDiv = document.getElementById('promptsList');
        
        if (!type) {
            promptsListDiv.innerHTML = '';
            return;
        }
        
        showLoading(promptsListDiv, 'åŠ è½½ä¸­...');
        
        try {
            let category = '';
            if (type === 'titles') {
                category = 'title';
            } else if (type === 'articles') {
                category = 'article';
            } else if (type === 'html') {
                category = 'html';
            }
            
            const result = await apiCall(`/prompts/${category}`);
            
            if (result.data.length === 0) {
                promptsListDiv.innerHTML = '<div class="info">æš‚æ— æç¤ºè¯æ¨¡æ¿</div>';
            } else {
                // æ¸…ç©ºå®¹å™¨
                promptsListDiv.innerHTML = '';
                
                // ä¸ºæ¯ä¸ª prompt åˆ›å»º DOM å…ƒç´ å¹¶ç›´æ¥æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
                result.data.forEach(prompt => {
                    const promptNameEscaped = escapeHtml(prompt.name);
                    const promptDescriptionEscaped = prompt.description ? escapeHtml(prompt.description) : 'æ— æè¿°';
                    
                    // åˆ›å»ºå®¹å™¨ div
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'list-item';
                    itemDiv.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;';
                    
                    // åˆ›å»ºå·¦ä¾§å†…å®¹ div
                    const contentDiv = document.createElement('div');
                    contentDiv.style.cssText = 'flex: 1; cursor: pointer;';
                    contentDiv.onclick = () => showPromptDetail(type, prompt.id);
                    contentDiv.innerHTML = `
                        <strong>${promptNameEscaped}${prompt.is_default ? ' <span style="color: #48bb78; font-size: 12px;">[é»˜è®¤]</span>' : ''}</strong>
                        <small style="display: block; margin-top: 5px; color: #718096;">${promptDescriptionEscaped}</small>
                    `;
                    
                    // åˆ›å»ºåˆ é™¤æŒ‰é’®
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-prompt-btn';
                    deleteBtn.style.cssText = 'background: #f56565; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-left: 15px; font-size: 14px;';
                    deleteBtn.title = 'åˆ é™¤æç¤ºè¯';
                    deleteBtn.textContent = 'ğŸ—‘ï¸ åˆ é™¤';
                    
                    // ä½¿ç”¨é—­åŒ…ç›´æ¥æ•è· prompt å¯¹è±¡
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
                        deletePrompt(prompt.id, prompt.name, e);
                    });
                    
                    // ç»„è£…å…ƒç´ 
                    itemDiv.appendChild(contentDiv);
                    itemDiv.appendChild(deleteBtn);
                    promptsListDiv.appendChild(itemDiv);
                });
            }
        } catch (error) {
            showError(promptsListDiv, `åŠ è½½å¤±è´¥: ${error.message}`);
        }
    }
    
    // æ˜¾ç¤ºæç¤ºè¯è¯¦æƒ…
    async function showPromptDetail(type, promptId) {
        const detailDiv = document.getElementById('promptDetail');
        const contentDiv = document.getElementById('promptContent');
        showLoading(contentDiv, 'åŠ è½½ä¸­...');
        detailDiv.style.display = 'block';
        
        try {
            const result = await apiCall(`/prompts/${promptId}`);
            
            let title = '';
            if (type === 'titles') {
                title = `æ ‡é¢˜: ${escapeHtml(result.data.name)}`;
            } else if (type === 'articles') {
                title = `çŸ­æ–‡: ${escapeHtml(result.data.name)}`;
            } else if (type === 'html') {
                title = `HTML: ${escapeHtml(result.data.name)}`;
            }
            
            contentDiv.innerHTML = `
                <h3>${title}</h3>
                <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                    <pre style="white-space: pre-wrap; word-wrap: break-word; color: #1a202c; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">${escapeHtml(result.data.content)}</pre>
                </div>
            `;
            detailDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } catch (error) {
            showError(contentDiv, `åŠ è½½å¤±è´¥: ${error.message}`);
        }
    }
    
    // å…³é—­æç¤ºè¯è¯¦æƒ…
    function closePromptDetail() {
        document.getElementById('promptDetail').style.display = 'none';
    }
    
    // åˆ é™¤æç¤ºè¯
    async function deletePrompt(promptId, promptName, event) {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé¿å…è§¦å‘åˆ—è¡¨é¡¹çš„ç‚¹å‡»äº‹ä»¶
        if (event) {
            event.stopPropagation();
        }
        
        // ç¡®è®¤åˆ é™¤ï¼ˆpromptName å·²ç»æ˜¯å­—ç¬¦ä¸²ï¼Œä¸éœ€è¦å†æ¬¡è½¬ä¹‰ï¼‰
        if (!confirm(`ç¡®å®šè¦åˆ é™¤æç¤ºè¯ "${promptName}" å—ï¼Ÿ\n\næ³¨æ„ï¼šåˆ é™¤åæ— æ³•æ¢å¤ã€‚å¦‚æœè¯¥æ¨¡æ¿æ­£åœ¨è¢«ä½¿ç”¨ï¼Œç›¸å…³è®°å½•å°†ä¿ç•™ï¼Œä½†ä¸å†å…³è”æ­¤æ¨¡æ¿ã€‚`)) {
            return;
        }
        
        const promptsListDiv = document.getElementById('promptsList');
        const originalContent = promptsListDiv.innerHTML;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoading(promptsListDiv, 'æ­£åœ¨åˆ é™¤...');
        
        try {
            const result = await apiCall(`/prompts/${promptId}`, {
                method: 'DELETE'
            });
            
            if (result.success) {
                // åˆ é™¤æˆåŠŸï¼Œåˆ·æ–°åˆ—è¡¨
                showSuccess(promptsListDiv, `æç¤ºè¯ "${escapeHtml(promptName)}" å·²æˆåŠŸåˆ é™¤`);
                // å»¶è¿Ÿåˆ·æ–°åˆ—è¡¨ï¼Œè®©ç”¨æˆ·çœ‹åˆ°æˆåŠŸæ¶ˆæ¯
                setTimeout(() => {
                    loadPrompts();
                }, 1500);
            } else {
                showError(promptsListDiv, `åˆ é™¤å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);
            }
        } catch (error) {
            showError(promptsListDiv, `åˆ é™¤å¤±è´¥: ${error.message}`);
            // æ¢å¤åŸå†…å®¹
            setTimeout(() => {
                promptsListDiv.innerHTML = originalContent;
            }, 2000);
        }
    }
</script>
{% endblock %}

