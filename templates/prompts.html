{% extends "base.html" %}

{% block title %}æç¤ºè¯ç®¡ç† - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block content %}
<div class="section">
    <h2>ğŸ“ æç¤ºè¯ç®¡ç†</h2>
    
    <!-- æ·»åŠ æç¤ºè¯è¡¨å• -->
    <div style="margin-bottom: 30px; padding: 20px; background: #f7fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
        <h3 style="margin-bottom: 15px; color: #1a202c;">â• æ·»åŠ æ–°æç¤ºè¯</h3>
        <div class="form-group">
            <label>ğŸ“‹ åˆ†ç±»ï¼š</label>
            <select id="addPromptCategory">
                <option value="">-- é€‰æ‹©åˆ†ç±» --</option>
                <option value="title">æ ‡é¢˜æç¤ºè¯</option>
                <option value="article">çŸ­æ–‡æç¤ºè¯</option>
                <option value="html">HTMLæç¤ºè¯</option>
            </select>
        </div>
        <div class="form-group">
            <label>ğŸ“ æ¨¡æ¿åç§°ï¼š</label>
            <input type="text" id="addPromptName" placeholder="ä¾‹å¦‚ï¼šé»˜è®¤æ ‡é¢˜æ¨¡æ¿ã€æƒ…æ„Ÿç±»æ ‡é¢˜æ¨¡æ¿...">
        </div>
        <div class="form-group">
            <label>ğŸ“„ æ¨¡æ¿æè¿°ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <input type="text" id="addPromptDescription" placeholder="ç®€è¦æè¿°è¿™ä¸ªæ¨¡æ¿çš„ç”¨é€”...">
        </div>
        <div class="form-group">
            <label>ğŸ“ æ¨¡æ¿å†…å®¹ï¼š</label>
            <textarea id="addPromptContent" rows="12" placeholder="è¯·è¾“å…¥æç¤ºè¯æ¨¡æ¿å†…å®¹...&#10;&#10;å¯ä»¥ä½¿ç”¨å ä½ç¬¦ï¼š&#10;- {{topic}} ç”¨äºæ ‡é¢˜ç”Ÿæˆ&#10;- {{content}} ç”¨äºHTMLç”Ÿæˆ"></textarea>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="checkbox" id="addPromptIsDefault" style="width: auto; margin-right: 8px;">
                <span>è®¾ä¸ºé»˜è®¤æ¨¡æ¿</span>
            </label>
        </div>
        <button onclick="addPrompt()">ğŸ’¾ ä¿å­˜æç¤ºè¯</button>
        <div id="addPromptResult" style="margin-top: 15px;"></div>
    </div>
    
    <!-- æŸ¥çœ‹æç¤ºè¯åˆ—è¡¨ -->
    <div style="margin-top: 30px;">
        <h3 style="margin-bottom: 15px; color: #1a202c;">ğŸ“‹ æŸ¥çœ‹æç¤ºè¯åˆ—è¡¨</h3>
        <div class="form-group">
            <label>é€‰æ‹©æŸ¥çœ‹ç±»å‹ï¼š</label>
            <select id="promptTypeSelect" onchange="loadPrompts()">
                <option value="">-- é€‰æ‹©ç±»å‹ --</option>
                <option value="titles">æ ‡é¢˜æç¤ºè¯</option>
                <option value="articles">çŸ­æ–‡æç¤ºè¯</option>
                <option value="html">HTMLæç¤ºè¯</option>
            </select>
        </div>
        <div id="promptsList"></div>
        <div id="promptDetail" style="display: none; margin-top: 20px; padding: 20px; background: #f7fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
            <button onclick="closePromptDetail()" style="background: #718096; margin-bottom: 15px;">å…³é—­</button>
            <div id="promptContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // æ·»åŠ æç¤ºè¯
    async function addPrompt() {
        const category = document.getElementById('addPromptCategory').value;
        const name = document.getElementById('addPromptName').value.trim();
        const description = document.getElementById('addPromptDescription').value.trim();
        const content = document.getElementById('addPromptContent').value.trim();
        const isDefault = document.getElementById('addPromptIsDefault').checked;
        
        if (!category) {
            alert('è¯·é€‰æ‹©åˆ†ç±»');
            return;
        }
        
        if (!name) {
            alert('è¯·è¾“å…¥æ¨¡æ¿åç§°');
            return;
        }
        
        if (!content) {
            alert('è¯·è¾“å…¥æ¨¡æ¿å†…å®¹');
            return;
        }
        
        const resultDiv = document.getElementById('addPromptResult');
        resultDiv.innerHTML = '<div class="loading">æ­£åœ¨ä¿å­˜...</div>';
        
        try {
            const response = await fetch('/api/prompts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    category: category,
                    name: name,
                    description: description || null,
                    content: content,
                    is_default: isDefault
                })
            });
            const result = await response.json();
            
            if (result.success) {
                resultDiv.innerHTML = `
                    <div class="success">âœ… æç¤ºè¯ä¿å­˜æˆåŠŸï¼</div>
                    <div style="margin-top: 10px;">
                        <strong>æ¨¡æ¿ID:</strong> ${result.data.id}<br>
                        <strong>åˆ†ç±»:</strong> ${result.data.category}<br>
                        <strong>åç§°:</strong> ${result.data.name}
                    </div>
                `;
                // æ¸…ç©ºè¡¨å•
                document.getElementById('addPromptCategory').value = '';
                document.getElementById('addPromptName').value = '';
                document.getElementById('addPromptDescription').value = '';
                document.getElementById('addPromptContent').value = '';
                document.getElementById('addPromptIsDefault').checked = false;
                
                // å¦‚æœå½“å‰æŸ¥çœ‹çš„ç±»å‹åŒ¹é…ï¼Œåˆ·æ–°åˆ—è¡¨
                const currentType = document.getElementById('promptTypeSelect').value;
                if (currentType && (
                    (currentType === 'titles' && category === 'title') ||
                    (currentType === 'articles' && category === 'article') ||
                    (currentType === 'html' && category === 'html')
                )) {
                    loadPrompts();
                }
            } else {
                resultDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
            }
        } catch (error) {
            resultDiv.innerHTML = `<div class="error">âŒ ä¿å­˜å¤±è´¥: ${error.message}</div>`;
        }
    }
    
    // åŠ è½½æç¤ºè¯åˆ—è¡¨
    async function loadPrompts() {
        const type = document.getElementById('promptTypeSelect').value;
        if (!type) {
            document.getElementById('promptsList').innerHTML = '';
            return;
        }
        
        const promptsListDiv = document.getElementById('promptsList');
        promptsListDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­</div>';
        
        try {
            let url = '';
            if (type === 'titles') {
                url = '/api/prompts/title';
            } else if (type === 'articles') {
                url = '/api/prompts/article';
            } else if (type === 'html') {
                url = '/api/prompts/html';
            }
            
            const response = await fetch(url);
            const result = await response.json();
            
            if (result.success) {
                if (result.data.length === 0) {
                    promptsListDiv.innerHTML = '<div class="info">æš‚æ— æç¤ºè¯æ¨¡æ¿</div>';
                } else {
                    promptsListDiv.innerHTML = result.data.map(prompt => `
                        <div class="list-item" onclick="showPromptDetail('${type}', ${prompt.id})" style="cursor: pointer;">
                            <strong>${prompt.name}</strong>
                            <small style="display: block; margin-top: 5px; color: #718096;">åˆ†ç±»: ${prompt.category}</small>
                        </div>
                    `).join('');
                }
            } else {
                promptsListDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
            }
        } catch (error) {
            promptsListDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
    }
    
    // æ˜¾ç¤ºæç¤ºè¯è¯¦æƒ…
    async function showPromptDetail(type, promptId) {
        const detailDiv = document.getElementById('promptDetail');
        const contentDiv = document.getElementById('promptContent');
        contentDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­</div>';
        detailDiv.style.display = 'block';
        
        try {
            const response = await fetch(`/api/prompts/${promptId}`);
            const result = await response.json();
            
            if (result.success) {
                let title = '';
                if (type === 'titles') {
                    title = `æ ‡é¢˜: ${result.data.name}`;
                } else if (type === 'article') {
                    title = `çŸ­æ–‡: ${result.data.name}`;
                } else if (type === 'html') {
                    title = `HTML: ${result.data.name}`;
                }
                
                contentDiv.innerHTML = `
                    <h3>${title}</h3>
                    <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <pre style="white-space: pre-wrap; word-wrap: break-word; color: #1a202c; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6;">${escapeHtml(result.data.content)}</pre>
                    </div>
                `;
                detailDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } else {
                contentDiv.innerHTML = `<div class="error">âŒ ${result.error}</div>`;
            }
        } catch (error) {
            contentDiv.innerHTML = `<div class="error">âŒ åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
    }
    
    // å…³é—­æç¤ºè¯è¯¦æƒ…
    function closePromptDetail() {
        document.getElementById('promptDetail').style.display = 'none';
    }
</script>
{% endblock %}

