{% extends "base.html" %}

{% block title %}æ­¥éª¤1: ç”Ÿæˆæ ‡é¢˜ - æ–‡ç« ç”Ÿæˆç³»ç»Ÿ{% endblock %}

{% block step_progress %}
<div class="step-progress">
    ğŸ“ å½“å‰æ­¥éª¤ï¼šåˆ›å»ºä¸»é¢˜å¹¶ç”Ÿæˆæ ‡é¢˜ â†’ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡
</div>
{% endblock %}

{% block content %}
<div class="section">
    <h2>æ­¥éª¤ 1: åˆ›å»ºä¸»é¢˜å¹¶ç”Ÿæˆæ ‡é¢˜</h2>
    
    <!-- æ¨¡å¼é€‰æ‹© -->
    <div class="form-group">
        <label>ğŸ“‹ é€‰æ‹©æ¨¡å¼ï¼š</label>
        <div style="display: flex; gap: 15px; margin-top: 10px;">
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="mode" value="generate" checked onchange="toggleMode()" style="width: auto; margin-right: 8px;">
                <span>è‡ªåŠ¨ç”Ÿæˆæ ‡é¢˜</span>
            </label>
            <label style="display: flex; align-items: center; cursor: pointer;">
                <input type="radio" name="mode" value="custom" onchange="toggleMode()" style="width: auto; margin-right: 8px;">
                <span>è‡ªå®šä¹‰æ ‡é¢˜</span>
            </label>
        </div>
    </div>
    
    <!-- è‡ªåŠ¨ç”Ÿæˆæ¨¡å¼ -->
    <div id="generateMode">
        <div class="form-group">
            <label>ğŸ“ æ–‡ç« ä¸»é¢˜ï¼š</label>
            <input type="text" id="topicInput" placeholder="ä¾‹å¦‚ï¼šä¸è¦æ‹çˆ±è„‘ã€èŒåœºç”©é”…ã€æ— æ•ˆç¤¾äº¤...">
        </div>
        <div class="form-group">
            <label>ğŸ“‹ é€‰æ‹©æç¤ºè¯æ¨¡æ¿ï¼ˆå¯é€‰ï¼‰ï¼š</label>
            <select id="titlePromptSelect">
                <option value="">ä½¿ç”¨é»˜è®¤æ¨¡æ¿</option>
            </select>
        </div>
        <button onclick="createTopic()">ğŸš€ ç”Ÿæˆæ ‡é¢˜</button>
    </div>
    
    <!-- è‡ªå®šä¹‰æ ‡é¢˜æ¨¡å¼ -->
    <div id="customMode" style="display: none;">
        <div class="form-group">
            <label>ğŸ“ æ–‡ç« ä¸»é¢˜ï¼š</label>
            <input type="text" id="customTopicInput" placeholder="ä¾‹å¦‚ï¼šä¸è¦æ‹çˆ±è„‘ã€èŒåœºç”©é”…ã€æ— æ•ˆç¤¾äº¤...">
        </div>
        <div class="form-group">
            <label>ğŸ“ è‡ªå®šä¹‰æ ‡é¢˜ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ï¼š</label>
            <textarea id="customTitlesInput" rows="8" placeholder="è¯·è¾“å…¥æ ‡é¢˜ï¼Œæ¯è¡Œä¸€ä¸ªï¼Œä¾‹å¦‚ï¼š&#10;æ„ŸåŠ¨è‡ªå·±çš„ä»˜å‡ºï¼Œæœ€å»‰ä»·ã€‚&#10;æ²¡æœ‰åº•çº¿çš„å–„è‰¯ï¼Œæ˜¯è ¢ã€‚&#10;æƒè¡¡åˆ©å¼Šçš„å©šå§»ï¼ŒçœŸè„ã€‚&#10;..." style="width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical; background: #ffffff; color: #1a202c;"></textarea>
        </div>
        <button onclick="saveCustomTitles()">ğŸ’¾ ä¿å­˜è‡ªå®šä¹‰æ ‡é¢˜</button>
    </div>
    
    <div id="titlesResult"></div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    window.onload = function() {
        loadPromptTemplates('title', 'titlePromptSelect');
    };
    
    // åˆ‡æ¢æ¨¡å¼
    function toggleMode() {
        const mode = document.querySelector('input[name="mode"]:checked').value;
        const generateMode = document.getElementById('generateMode');
        const customMode = document.getElementById('customMode');
        
        if (mode === 'generate') {
            generateMode.style.display = 'block';
            customMode.style.display = 'none';
        } else {
            generateMode.style.display = 'none';
            customMode.style.display = 'block';
        }
    }
    
    // åˆ›å»ºä¸»é¢˜å¹¶ç”Ÿæˆæ ‡é¢˜
    async function createTopic() {
        const topicText = document.getElementById('topicInput').value.trim();
        if (!topicText) {
            showError(document.getElementById('titlesResult'), 'è¯·è¾“å…¥æ–‡ç« ä¸»é¢˜');
            return;
        }
        
        const templateId = document.getElementById('titlePromptSelect').value || null;
        const resultDiv = document.getElementById('titlesResult');
        const btn = event.target;
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btn.disabled = true;
        showLoading(resultDiv, 'æ­£åœ¨ç”Ÿæˆæ ‡é¢˜...');
        
        try {
            const result = await apiCall('/topics', {
                method: 'POST',
                body: {
                    topic_text: topicText,
                    template_id: templateId ? parseInt(templateId) : null
                }
            });
            
            // å¤„ç†è¿”å›çš„æ•°æ®æ ¼å¼
            const titles = result.data.titles || [];
            
            resultDiv.innerHTML = `
                <div class="success">âœ… æˆåŠŸç”Ÿæˆ ${titles.length} ä¸ªæ ‡é¢˜ï¼</div>
                <div style="margin-top: 15px;">
                    <strong>ä¸»é¢˜ï¼š</strong> ${escapeHtml(result.data.topic_text || topicText)}<br>
                    <strong>æ ‡é¢˜åˆ—è¡¨ï¼š</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        ${titles.map(t => {
                            // å¤„ç†ä¸åŒçš„æ•°æ®æ ¼å¼ï¼šå¯èƒ½æ˜¯å­—ç¬¦ä¸²æ•°ç»„ï¼Œä¹Ÿå¯èƒ½æ˜¯å¯¹è±¡æ•°ç»„
                            const titleText = typeof t === 'string' ? t : (t.title_text || t);
                            return `<li style="margin: 8px 0; color: #1a202c;">${escapeHtml(titleText)}</li>`;
                        }).join('')}
                    </ul>
                </div>
                <div style="margin-top: 20px;">
                    <a href="/step2" class="next-step-btn">
                        <button>â¡ï¸ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡</button>
                    </a>
                </div>
            `;
            document.getElementById('topicInput').value = '';
        } catch (error) {
            showError(resultDiv, `ç”Ÿæˆå¤±è´¥: ${error.message}`);
        } finally {
            btn.disabled = false;
        }
    }
    
    // ä¿å­˜è‡ªå®šä¹‰æ ‡é¢˜
    async function saveCustomTitles() {
        const topicText = document.getElementById('customTopicInput').value.trim();
        const titlesText = document.getElementById('customTitlesInput').value.trim();
        
        if (!topicText) {
            showError(document.getElementById('titlesResult'), 'è¯·è¾“å…¥æ–‡ç« ä¸»é¢˜');
            return;
        }
        
        if (!titlesText) {
            showError(document.getElementById('titlesResult'), 'è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæ ‡é¢˜');
            return;
        }
        
        // è§£ææ ‡é¢˜ï¼ˆæŒ‰è¡Œåˆ†å‰²ï¼Œè¿‡æ»¤ç©ºè¡Œï¼‰
        const titles = titlesText.split('\n')
            .map(t => t.trim())
            .filter(t => t.length > 0);
        
        if (titles.length === 0) {
            showError(document.getElementById('titlesResult'), 'è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªæœ‰æ•ˆçš„æ ‡é¢˜');
            return;
        }
        
        const resultDiv = document.getElementById('titlesResult');
        const btn = event.target;
        
        // ç¦ç”¨æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æäº¤
        btn.disabled = true;
        showLoading(resultDiv, 'æ­£åœ¨ä¿å­˜æ ‡é¢˜...');
        
        try {
            const result = await apiCall('/topics/custom', {
                method: 'POST',
                body: {
                    topic_text: topicText,
                    titles: titles
                }
            });
            
            resultDiv.innerHTML = `
                <div class="success">âœ… æˆåŠŸä¿å­˜ ${result.data.titles.length} ä¸ªè‡ªå®šä¹‰æ ‡é¢˜ï¼</div>
                <div style="margin-top: 15px;">
                    <strong>ä¸»é¢˜ï¼š</strong> ${escapeHtml(result.data.topic_text)}<br>
                    <strong>æ ‡é¢˜åˆ—è¡¨ï¼š</strong>
                    <ul style="margin-top: 10px; padding-left: 20px;">
                        ${result.data.titles.map(t => `<li style="margin: 8px 0; color: #1a202c;">${escapeHtml(t.title_text)}</li>`).join('')}
                    </ul>
                </div>
                <div style="margin-top: 20px;">
                    <a href="/step2" class="next-step-btn">
                        <button>â¡ï¸ ä¸‹ä¸€æ­¥ï¼šé€‰æ‹©æ ‡é¢˜ç”ŸæˆçŸ­æ–‡</button>
                    </a>
                </div>
            `;
            document.getElementById('customTopicInput').value = '';
            document.getElementById('customTitlesInput').value = '';
        } catch (error) {
            showError(resultDiv, `ä¿å­˜å¤±è´¥: ${error.message}`);
        } finally {
            btn.disabled = false;
        }
    }
</script>
{% endblock %}

